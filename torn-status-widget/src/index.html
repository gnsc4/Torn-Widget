<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Status Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif !important;
            margin: 0;
            padding: 0;
            background-color: transparent;
            overflow: hidden;
        }

        #torn-status-gui {
            background-color: rgba(30, 30, 30, 0.95) !important;
            border: 1px solid #999 !important;
            border-radius: 5px !important;
            padding: 10px !important;
            color: #ddd !important;
            font-size: 13px !important;
            min-width: 225px !important; /* Increased min-width slightly */
            box-shadow: 0 2px 15px rgba(0,0,0,0.6) !important;
            user-select: none !important;
            box-sizing: border-box !important;
            display: flex;
            flex-direction: column;
        }
        #torn-status-gui.minimized {
            padding: 0 !important; min-width: 0 !important;
            width: 35px !important; height: 35px !important;
            overflow: hidden !important; cursor: pointer !important;
        }
        #torn-status-gui.minimized #torn-status-content-area,
        #torn-status-gui.minimized #torn-status-header h3,
        #torn-status-gui.minimized #torn-status-settings-btn,
        #torn-status-gui.minimized #torn-status-close-btn,
        #torn-status-gui.minimized #widget-version,
        #torn-status-gui.minimized #torn-status-settings-panel
        { display: none !important; }

        #torn-status-gui.minimized #torn-status-header {
             padding: 0 !important; margin: 0 !important; border-bottom: none !important;
             min-height: 35px !important; display: flex !important;
             align-items: center !important; justify-content: center !important;
        }
        #torn-status-gui.minimized #torn-status-minimize-btn {
             position: static !important; margin: 0 !important; padding: 5px !important;
             font-size: 17px !important;
             line-height: 1 !important;
        }
        #torn-status-header {
            display: flex !important; justify-content: space-between !important;
            align-items: center !important; border-bottom: 1px solid #666 !important;
            margin-bottom: 8px !important; padding-bottom: 8px !important;
            cursor: grab !important;
        }
        #torn-status-header h3 {
             margin: 0 !important; font-size: 15px !important;
             font-weight: bold !important; color: #fff !important; flex-grow: 1;
             pointer-events: none !important;
        }
        .header-button {
            background: #555 !important; border: 1px solid #777 !important; color: #fff !important;
            cursor: pointer !important; padding: 3px 6px !important; border-radius: 3px !important;
            font-weight: bold !important; line-height: 1 !important; margin-left: 5px !important;
            font-size: 13px;
        }
        .header-button:hover { background: #777 !important; }

        #torn-status-content-area {
            flex-grow: 1;
            position: relative; /* For positioning settings panel */
        }

        #torn-status-notifications,
        #torn-status-content > div, /* Each status row */
        #torn-status-api-setup div,
        #torn-status-refills > div,
        #torn-new-day-timer-container /* Style for new day timer */
        { margin-bottom: 5px !important; line-height: 1.4 !important; }

        .bar-link, .refill-link, .status-link, .notification-link {
            display: flex;
            align-items: center;
            text-decoration: none; color: inherit;
            cursor: pointer; padding: 2px 0; border-radius: 3px;
        }
        .bar-link:hover, .refill-link:hover, .status-link:hover, .notification-link:hover { background-color: rgba(255, 255, 255, 0.05); }

        #torn-status-content > div > .status-link > span:first-child,
        #torn-status-content > div > .bar-link > span:first-child,
        #torn-status-refills > div > .refill-link > span:first-child,
        #torn-new-day-timer-container > span:first-child {
            display: inline-block !important;
            min-width: 60px !important;
            font-weight: bold !important;
            color: #aaa !important;
            flex-shrink: 0;
        }

        #torn-status-content .value-container,
        #torn-new-day-timer-container .value-container
        {
            flex-grow: 1;
            display: flex;
            align-items: center;
            margin-left: 8px;
            overflow: hidden;
        }

        #torn-status-content .value {
             display: inline-block !important;
             text-align: right !important;
             margin-right: 5px !important;
             font-weight: bold !important;
        }
        #torn-status-content .life-value { color: #ff7f7f !important; }
        #torn-status-content .energy-value { color: #99dd99 !important; }
        #torn-status-content .nerve-value { color: #ff6666 !important; }
        #torn-status-content .happy-value { color: #ffff99 !important; }
        #torn-status-content .booster-value { color: #87CEFA !important; }
        #torn-status-content .medical-value { color: #AFEEEE !important; }
        #torn-status-content .drug-value { color: #DDA0DD !important; }

        .life-bar-wrapper {
            position: relative;
            flex-grow: 1;
            height: 18px;
            display: flex;
            align-items: center;
        }

        .health-bar-container {
            width: 100%;
            height: 100%;
            background-color: #444;
            border: 1px solid #666;
            border-radius: 3px;
            overflow: hidden;
        }

        .health-bar-fill {
            height: 100%;
            width: 0%;
            background-color: #28a745;
            border-radius: 2px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }

        .life-value-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff !important;
            text-shadow:
                -1px -1px 0 #000,
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 0px 0px 3px rgba(0,0,0,0.8);
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            z-index: 1;
            pointer-events: none;
            margin-right: 0 !important;
            width: auto;
            white-space: nowrap;
        }
        #torn-new-day-timer-container {
            display: flex;
            align-items: center;
        }
        #torn-new-day-timer-container .new-day-timer-value {
            font-weight: bold;
            color: #FFD700;
            margin-left: 5px;
        }
        #torn-new-day-timer-container .new-day-timer-value.new-day-warning {
            color: #ff6666 !important;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .flashing {
            animation: flash 1s infinite;
        }

        #torn-status-notifications {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .notification-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        .notification-item:last-child {
            margin-right: 0;
        }
        .notification-icon svg {
            width: 17px;
            height: 17px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .notification-count {
            font-weight: bold;
            font-size: 13px;
        }
        .notification-icon.green, .notification-count.green {
            fill: #28a745;
            color: #28a745 !important;
        }
        .notification-icon.red, .notification-count.red {
            fill: #dc3545;
            color: #dc3545 !important;
        }

        #torn-status-refills .refill-status {
            display: inline-block !important; min-width: 70px !important;
            text-align: right !important; margin-right: 5px !important; font-weight: bold !important;
        }
        #torn-status-refills .refill-status.ready { color: #99dd99 !important; }
        #torn-status-refills .refill-status.used { color: #ff6666 !important; }

        #torn-status-content .timer {
            font-weight: bold !important;
            margin-left: 5px !important;
            white-space: nowrap;
        }
        #torn-status-content .timer.full { color: #ffff99 !important; }

        #torn-status-content .energy-timer { color: #99dd99 !important; }
        #torn-status-content .nerve-timer { color: #ff6666 !important; }
        #torn-status-content .happy-timer { color: #ffff99 !important; }
        #torn-status-content .booster-timer { color: #87CEFA !important; }
        #torn-status-content .medical-timer { color: #AFEEEE !important; }
        #torn-status-content .drug-timer { color: #DDA0DD !important; }

        .error { color: #ff6666 !important; font-weight: bold !important; margin-top: 5px !important; }

        #torn-status-api-setup { padding-top: 5px !important; }
        #torn-status-api-setup input[type="text"] {
            padding:4px 6px!important; border:1px solid #888!important; border-radius:3px!important;
            margin-right:5px!important; width:calc(100% - 80px)!important;
            background-color:#fff!important; font-size: 13px;
            color:#000!important; box-sizing:border-box!important
        }
        #torn-status-api-setup button {
            padding:4px 10px!important; border:1px solid #999!important; border-radius:3px!important;
            background-color:#ccc!important; color:#000!important; cursor:pointer!important;
            font-weight:bold!important; box-sizing:border-box!important; font-size: 13px;
        }
        #torn-status-api-setup button:hover { background-color:#ddd!important }
        #torn-status-api-setup p { margin-bottom:8px!important; font-size:12px!important; color:#ccc!important }
        #torn-status-api-setup a { color:#aaa!important; text-decoration:underline!important }
        #torn-status-api-setup a:hover { color:#ccc!important }

        #first-run-autostart-option {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed #555;
            font-size: 12px;
        }
        #first-run-autostart-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        #first-run-autostart-checkbox {
            margin-right: 8px;
        }

        .section-divider {
            border-top: 1px dashed #555;
            margin-top: 8px;
            padding-top: 8px;
        }
        #custom-tooltip {
            position: fixed;
            display: none;
            background-color: rgba(10, 10, 10, 0.9);
            color: #eee;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 12px;
            z-index: 100000;
            pointer-events: none;
            white-space: pre-line;
            max-width: 250px;
        }
        #widget-version {
            font-size: 11px;
            color: #777;
            text-align: center;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #444;
        }
        #widget-version a {
            color: #88aaff;
            text-decoration: none;
        }
        #widget-version a:hover {
            text-decoration: underline;
        }
        #update-notification {
            display: none; /* Hidden by default */
            margin-left: 5px;
            font-weight: bold;
        }
        #update-notification a {
            color: #ffc107; /* Yellow/gold for update notice */
            text-decoration: underline;
        }
         #update-notification a:hover {
            color: #fff;
        }


        /* Settings Panel Styles */
        #torn-status-settings-panel {
            position: absolute;
            top: -10px; 
            left: -10px;
            right: -10px;
            bottom: -10px;
            background-color: rgba(40, 40, 40, 0.98); 
            padding: 15px 10px; 
            border-radius: 5px; 
            z-index: 100;
            display: none; 
            flex-direction: column;
            font-size: 13px;
        }
        #torn-status-settings-panel h4 {
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #666;
            font-size: 15px;
            color: #fff;
            text-align: center;
        }
        .settings-section {
            margin-bottom: 15px;
        }
         .settings-section:last-of-type { 
            margin-bottom: 10px;
        }
        .settings-section p {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #ccc;
        }
        .settings-section input[type="text"] {
            width: calc(100% - 75px); 
            padding: 4px 6px !important;
            border: 1px solid #888 !important;
            border-radius: 3px !important;
            margin-right: 5px !important;
            background-color: #fff !important;
            color: #000 !important;
            box-sizing: border-box !important;
            font-size: 13px;
        }
        .settings-section button {
            padding: 4px 10px !important;
            border: 1px solid #999 !important;
            border-radius: 3px !important;
            background-color: #ccc !important;
            color: #000 !important;
            cursor: pointer !important;
            font-weight: bold !important;
            box-sizing: border-box !important;
            font-size: 13px;
        }
        .settings-section button:hover { background-color: #ddd !important; }
        .settings-section .error { margin-top: 5px; font-size: 12px; }

        .settings-autostart-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
            color: #ddd; 
        }
         #settings-autostart-checkbox {
            margin-right: 8px;
        }

        #settings-close-btn-container {
            margin-top: auto; 
            text-align: right;
            padding-top: 10px; 
            border-top: 1px solid #555; 
        }

        .link-preference-item {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            margin-bottom: 10px;
        }
        .link-preference-item-label { 
            min-width: 60px; 
            color: #ddd;
            font-size: 13px;
            margin-right: 5px; 
            flex-shrink: 0; 
        }
        .toggle-group { 
            display: flex;
            align-items: center;
        }
        .toggle-option-label {
            font-size: 12px;
            color: #999;
            cursor: default;
            transition: color 0.3s ease, font-weight 0.3s ease;
            white-space: nowrap; 
        }
        .toggle-option-label.personal-label { margin-right: 6px; } 
        .toggle-option-label.faction-label { margin-left: 6px; } 

        .toggle-option-label.active-preference {
            color: #fff;
            font-weight: bold;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px; 
            height: 20px; 
            flex-shrink: 0; 
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider-round {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #777; 
            transition: .4s;
            border-radius: 20px; 
        }
        .slider-round:before {
            position: absolute;
            content: "";
            height: 14px; 
            width: 14px;  
            left: 3px;    
            bottom: 3px;  
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider-round {
            background-color: #28a745; 
        }
        input:checked + .slider-round:before {
            transform: translateX(20px); 
        }

    </style>
</head>
<body>
    <div id="torn-status-gui">
        <div id="torn-status-header" data-tauri-drag-region>
            <h3>Status</h3>
            <button id="torn-status-settings-btn" class="header-button" title="Settings">⚙️</button>
            <button id="torn-status-minimize-btn" class="header-button" title="Minimize">−</button>
            <button id="torn-status-close-btn" class="header-button" title="Close Widget">×</button>
        </div>

        <div id="torn-status-content-area">
            <div id="torn-status-api-setup" style="display: none;">
                <p>Enter Torn API Key (<a href="https://www.torn.com/preferences.php#tab=api" target="_blank" title="Go to API Key settings">Get Key</a>):</p>
                <div>
                    <input type="text" id="torn-api-key-input-main" placeholder="Your API Key">
                    <button id="torn-api-key-save-btn-main">Save</button>
                </div>
                <div class="error api-error-main"></div>
                <div id="first-run-autostart-option" style="display: none;">
                    <label>
                        <input type="checkbox" id="first-run-autostart-checkbox">
                        Start widget on system boot
                    </label>
                </div>
            </div>

            <div id="torn-status-notifications" style="display: none;">
                <a href="https://www.torn.com/messages.php" target="_blank" class="notification-link notification-item" title="Go to Messages">
                    <span class="notification-icon messages-icon"></span>
                    <span class="notification-count messages-count">--</span>
                </a>
                <a href="https://www.torn.com/events.php" target="_blank" class="notification-link notification-item" title="Go to Events">
                    <span class="notification-icon events-icon"></span>
                    <span class="notification-count events-count">--</span>
                </a>
            </div>

            <div id="torn-status-content" class="section-divider" style="display: none;">
                <div> <a id="life-link" href="https://www.torn.com/item.php#medical-items" target="_blank" class="status-link" title="Go to Medical Items">
                        <span>Life:</span>
                        <div class="value-container life-bar-wrapper"> <div class="health-bar-container">
                                <div class="health-bar-fill"></div>
                            </div>
                            <span class="value life-value life-value-overlay">--/--</span>
                        </div>
                    </a>
                </div>
                <div> <a href="https://www.torn.com/gym.php" target="_blank" class="bar-link timer-hover-area" title="Go to Gym">
                        <span>Energy:</span>
                        <div class="value-container"> <span class="value energy-value">--/--</span>
                           <span class="timer energy-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div> <a href="https://www.torn.com/loader.php?sid=crimes#/" target="_blank" class="bar-link timer-hover-area" title="Go to Crimes">
                        <span>Nerve:</span>
                        <div class="value-container">
                            <span class="value nerve-value">--/--</span>
                            <span class="timer nerve-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div> <a href="https://www.torn.com/item.php#candy-items" target="_blank" class="status-link timer-hover-area" title="Go to Candy Items">
                        <span>Happy:</span>
                        <div class="value-container">
                            <span class="value happy-value">--/--</span>
                            <span class="timer happy-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div class="section-divider"></div>
                <div> <a id="booster-cooldown-link" href="https://www.torn.com/item.php#energy-d-items" target="_blank" class="bar-link timer-hover-area" title="Go to Boosters/Energy Drinks">
                        <span>Booster:</span>
                        <div class="value-container">
                            <span class="value booster-value">Ready</span>
                            <span class="timer booster-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div> <a id="medical-cooldown-link" href="https://www.torn.com/item.php#medical-items" target="_blank" class="bar-link timer-hover-area" title="Go to Medical Items">
                        <span>Medical:</span>
                        <div class="value-container">
                            <span class="value medical-value">Ready</span>
                            <span class="timer medical-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div> <a id="drug-cooldown-link" href="https://www.torn.com/item.php#drugs-items" target="_blank" class="bar-link timer-hover-area" title="Go to Drugs">
                        <span>Drug:</span>
                        <div class="value-container">
                            <span class="value drug-value">Ready</span>
                            <span class="timer drug-timer" data-tooltip-content="">--:--:--</span>
                        </div>
                    </a>
                </div>
                <div class="error status-error"></div>
            </div>

            <div id="torn-status-refills" class="section-divider" style="display: none;">
                 <div id="torn-new-day-timer-container"> <span>New Day:</span>
                    <div class="value-container">
                        <span class="new-day-timer-value">--:--:--</span>
                    </div>
                </div>
                 <div>
                    <a id="energy-refill-link" href="https://www.torn.com/page.php?sid=points" target="_blank" class="refill-link" title="Go to Points Building">
                        <span>E Refill:</span><span class="refill-status energy-refill-status">--</span>
                    </a>
                </div>
                 <div>
                    <a id="nerve-refill-link" href="https://www.torn.com/page.php?sid=points" target="_blank" class="refill-link" title="Go to Points Building">
                        <span>N Refill:</span><span class="refill-status nerve-refill-status">--</span>
                    </a>
                </div>
                 <div>
                    <a id="token-refill-link" href="https://www.torn.com/page.php?sid=points" target="_blank" class="refill-link" title="Go to Points Building">
                        <span>T Refill:</span><span class="refill-status token-refill-status">--</span>
                    </a>
                </div>
            </div>

            <div id="torn-status-settings-panel" style="display: none;">
                <h4>Settings</h4>
                <div class="settings-section">
                    <p>API Key Management:</p>
                    <input type="text" id="torn-api-key-input-settings" placeholder="Enter new API Key (optional)">
                    <button id="torn-api-key-save-btn-settings">Save Key</button>
                    <button id="torn-api-key-clear-btn-settings" style="margin-left: 5px; background-color: #d44a4a !important;">Clear Key</button>
                    <div class="error api-error-settings"></div>
                </div>

                <div class="settings-section" id="link-preferences-section">
                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #eee; font-weight:bold;">Item Link Destinations:</p>

                    <div class="link-preference-item">
                        <span class="link-preference-item-label">Drugs:</span>
                        <div class="toggle-group">
                            <span class="toggle-option-label personal-label" id="drug-personal-label">Personal</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="drug-link-type-toggle">
                                <span class="slider-round"></span>
                            </label>
                            <span class="toggle-option-label faction-label" id="drug-faction-label">Faction</span>
                        </div>
                    </div>

                    <div class="link-preference-item">
                        <span class="link-preference-item-label">Boosters:</span>
                        <div class="toggle-group">
                            <span class="toggle-option-label personal-label" id="booster-personal-label">Personal</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="booster-link-type-toggle">
                                <span class="slider-round"></span>
                            </label>
                            <span class="toggle-option-label faction-label" id="booster-faction-label">Faction</span>
                        </div>
                    </div>

                    <div class="link-preference-item">
                        <span class="link-preference-item-label">Medical:</span>
                        <div class="toggle-group">
                            <span class="toggle-option-label personal-label" id="medical-personal-label">Personal</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="medical-link-type-toggle">
                                <span class="slider-round"></span>
                            </label>
                            <span class="toggle-option-label faction-label" id="medical-faction-label">Faction</span>
                        </div>
                    </div>

                    <div class="link-preference-item">
                        <span class="link-preference-item-label">E Refill:</span>
                        <div class="toggle-group">
                            <span class="toggle-option-label personal-label" id="energyRefill-personal-label">Personal</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="energyRefill-link-type-toggle">
                                <span class="slider-round"></span>
                            </label>
                            <span class="toggle-option-label faction-label" id="energyRefill-faction-label">Faction</span>
                        </div>
                    </div>

                    <div class="link-preference-item">
                        <span class="link-preference-item-label">N Refill:</span>
                        <div class="toggle-group">
                            <span class="toggle-option-label personal-label" id="nerveRefill-personal-label">Personal</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="nerveRefill-link-type-toggle">
                                <span class="slider-round"></span>
                            </label>
                            <span class="toggle-option-label faction-label" id="nerveRefill-faction-label">Faction</span>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <label class="settings-autostart-label">
                        <input type="checkbox" id="settings-autostart-checkbox">
                        Start widget on system boot
                    </label>
                </div>
                 <div id="settings-close-btn-container">
                    <button id="settings-panel-close-btn">Close</button>
                </div>
            </div>
        </div>
        <div id="widget-version">
            <span id="update-notification" style="display:none;"> <a href="#" target="_blank">New version available!</a>
            </span>
        </div>
    </div>
    <div id="custom-tooltip" style="display:none;"></div>

    <script type="module">
        import { appWindow, LogicalSize } from 'https://cdn.jsdelivr.net/npm/@tauri-apps/api@^1/window.js';
        import { invoke } from 'https://cdn.jsdelivr.net/npm/@tauri-apps/api@^1/tauri.js';

        (function() {
            'use strict';
            const SCRIPT_VERSION = "1.0.18"; // Current script version
            const FORUM_THREAD_URL = "https://www.torn.com/forums.php#/p=threads&f=67&t=16473214&b=0&a=0";
            const AUTHOR_NAME = "GNSC4 [268863]";
            const AUTHOR_URL = "https://www.torn.com/profiles.php?XID=268863";
            const GITHUB_RELEASES_API_URL = "https://api.github.com/repos/gnsc4/Torn-Widget/releases/latest";
            const GITHUB_RELEASES_PAGE_URL = "https://github.com/gnsc4/Torn-Widget/releases";


            const UPDATE_INTERVAL_MS = 15 * 1000;
            const API_KEY_STORAGE = 'torn_status_api_key_v1_widget';
            const GUI_MINIMIZED_STORAGE = 'torn_status_gui_minimized_v1_widget';
            const AUTOSTART_PREFERENCE_STORAGE = 'torn_autostart_preference_v1_widget';
            const LINK_TYPE_SETTINGS_PREFIX = 'torn_link_type_v1_widget_';

            let apiKey, isMinimized;
            let intervals = { update:null,energy:null,nerve:null,happiness:null, booster:null, medical:null, drug:null, newDay: null };
            let guiContainer, minimizeButton, customTooltipElement;
            let lifeDisplayValue, energyDisplayValue, nerveDisplayValue, happinessDisplayValue, boosterDisplayValue, medicalDisplayValue, drugDisplayValue;
            let energyTimerDisplay, nerveTimerDisplay, happinessTimerDisplay, boosterTimerDisplay, medicalTimerDisplay, drugTimerDisplay;
            let newDayTimerDisplay;
            let apiSetupDiv, statusDiv, refillsDiv, notificationsDiv, versionDiv, updateNotificationElement; // Added updateNotificationElement
            let energyRefillStatus, nerveRefillStatus, tokenRefillStatus;
            let messagesIconDisplay, messagesCountDisplay, eventsIconDisplay, eventsCountDisplay;
            let closeButton, settingsButton;
            let healthBarFillDisplay;

            let apiKeyInputMain, apiKeySaveButtonMain, apiErrorMain, firstRunAutostartOptionDiv, firstRunAutostartCheckbox;
            let settingsPanel, settingsApiKeyInput, settingsApiKeySaveButton, settingsApiKeyClearButton, settingsApiError, settingsAutostartCheckbox, settingsPanelCloseButton;

            let userMaxBoosterCooldownSeconds = 48 * 3600;
            let userMaxMedicalCooldownSeconds = 6 * 3600;

            const mailIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>`;
            const eventIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor" width="16px" height="16px"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`;

            const itemLinkUrls = {
                drug: {
                    personal: 'https://www.torn.com/item.php#drugs-items',
                    faction: 'https://www.torn.com/factions.php?step=your#armoury-drugs',
                    elementId: 'drug-cooldown-link',
                    toggleId: 'drug-link-type-toggle',
                    personalLabelId: 'drug-personal-label',
                    factionLabelId: 'drug-faction-label'
                },
                booster: {
                    personal: 'https://www.torn.com/item.php#energy-d-items',
                    faction: 'https://www.torn.com/factions.php?step=your#armoury-boosters',
                    elementId: 'booster-cooldown-link',
                    toggleId: 'booster-link-type-toggle',
                    personalLabelId: 'booster-personal-label',
                    factionLabelId: 'booster-faction-label'
                },
                medical: {
                    personal: 'https://www.torn.com/item.php#medical-items',
                    faction: 'https://www.torn.com/factions.php?step=your#armoury-medical',
                    elementIds: ['medical-cooldown-link', 'life-link'],
                    toggleId: 'medical-link-type-toggle',
                    personalLabelId: 'medical-personal-label',
                    factionLabelId: 'medical-faction-label'
                },
                energyRefill: {
                    personal: 'https://www.torn.com/page.php?sid=points',
                    faction: 'https://www.torn.com/factions.php?step=your#armoury-points',
                    elementId: 'energy-refill-link',
                    toggleId: 'energyRefill-link-type-toggle',
                    personalLabelId: 'energyRefill-personal-label',
                    factionLabelId: 'energyRefill-faction-label'
                },
                nerveRefill: {
                    personal: 'https://www.torn.com/page.php?sid=points',
                    faction: 'https://www.torn.com/factions.php?step=your#armoury-points',
                    elementId: 'nerve-refill-link',
                    toggleId: 'nerveRefill-link-type-toggle',
                    personalLabelId: 'nerveRefill-personal-label',
                    factionLabelId: 'nerveRefill-faction-label'
                }
            };
            let linkTargetElements = {};
            let linkToggleElements = {};


            async function enablePluginAutostart() {
                try {
                    await invoke('plugin:autostart|enable');
                    console.log('Autostart enabled via official plugin.');
                } catch (e) {
                    console.error('Failed to enable autostart via official plugin:', e);
                }
            }

            async function disablePluginAutostart() {
                try {
                    await invoke('plugin:autostart|disable');
                    console.log('Autostart disabled via official plugin.');
                } catch (e) {
                    console.error('Failed to disable autostart via official plugin:', e);
                }
            }

            async function isPluginAutostartEnabled() {
                try {
                    const enabled = await invoke('plugin:autostart|is_enabled');
                    console.log('Official plugin autostart status:', enabled);
                    return enabled;
                } catch (e) {
                    console.error('Failed to check official plugin autostart status:', e);
                    return false;
                }
            }

            async function resizeWindowToContent() {
                if (!guiContainer || !appWindow || !versionDiv || !document.getElementById('torn-status-header')) return;

                const wasGuiHidden = guiContainer.style.display === 'none';
                if (wasGuiHidden) {
                    guiContainer.style.visibility = 'hidden';
                    guiContainer.style.display = 'block';
                }

                guiContainer.offsetHeight; 

                const header = document.getElementById('torn-status-header');
                let calculatedInnerHeight = 0;

                calculatedInnerHeight += header.offsetHeight;
                calculatedInnerHeight += parseInt(getComputedStyle(header).marginBottom) || 0;

                if (settingsPanel && settingsPanel.style.display === 'flex') {
                    calculatedInnerHeight += settingsPanel.offsetHeight;
                    const settingsStyle = getComputedStyle(settingsPanel);
                    calculatedInnerHeight += (parseInt(settingsStyle.paddingTop) || 0) + (parseInt(settingsStyle.paddingBottom) || 0);

                } else {
                    let mainContentActualHeight = 0;
                    const mainSections = [apiSetupDiv, notificationsDiv, statusDiv, refillsDiv, firstRunAutostartOptionDiv];
                    let isFirstVisibleInSection = true;
                    let previousMarginBottom = 0;

                    for (const section of mainSections) {
                        if (section && getComputedStyle(section).display !== 'none') {
                            const sectionStyle = getComputedStyle(section);
                            const currentMarginTop = parseInt(sectionStyle.marginTop) || 0;

                            if (!isFirstVisibleInSection) {
                                mainContentActualHeight += Math.max(previousMarginBottom, currentMarginTop);
                            } else {
                                mainContentActualHeight += currentMarginTop;
                            }
                            mainContentActualHeight += section.offsetHeight;
                            previousMarginBottom = parseInt(sectionStyle.marginBottom) || 0;
                            isFirstVisibleInSection = false;
                        }
                    }
                    if (!isFirstVisibleInSection) {
                        mainContentActualHeight += previousMarginBottom;
                    }
                    calculatedInnerHeight += mainContentActualHeight;
                }

                calculatedInnerHeight += parseInt(getComputedStyle(versionDiv).marginTop) || 0;
                calculatedInnerHeight += versionDiv.offsetHeight;

                const guiStyle = getComputedStyle(guiContainer);
                const finalWindowHeight = calculatedInnerHeight +
                                     (parseInt(guiStyle.paddingTop) || 0) +
                                     (parseInt(guiStyle.paddingBottom) || 0) +
                                     (parseInt(guiStyle.borderTopWidth) || 0) +
                                     (parseInt(guiStyle.borderBottomWidth) || 0) +
                                     ( (settingsPanel && settingsPanel.style.display === 'flex') ? 0 : 10); 

                if (wasGuiHidden) {
                    guiContainer.style.display = 'none';
                    guiContainer.style.visibility = 'visible';
                }
                requestAnimationFrame(async () => {
                    try {
                        const currentWidth = guiContainer.offsetWidth;

                        if (finalWindowHeight > 0 && currentWidth > 0) {
                            await appWindow.setSize(new LogicalSize(Math.ceil(currentWidth), Math.ceil(finalWindowHeight)));
                        }
                    } catch (e) {
                        console.error("Error resizing window (RAF):", e);
                    }
                });
            }

            function formatSecondsToHMS(totalSeconds) {
                if (isNaN(totalSeconds) || totalSeconds < 0) return '--:--:--';
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = Math.floor(totalSeconds % 60);
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }

            function cacheGUIElements() {
                guiContainer = document.getElementById('torn-status-gui');
                minimizeButton = document.getElementById('torn-status-minimize-btn');
                closeButton = document.getElementById('torn-status-close-btn');
                settingsButton = document.getElementById('torn-status-settings-btn');
                customTooltipElement = document.getElementById('custom-tooltip');
                versionDiv = document.getElementById('widget-version');
                updateNotificationElement = document.getElementById('update-notification'); // Cache update notification element

                apiSetupDiv = document.getElementById('torn-status-api-setup');
                apiKeyInputMain = document.getElementById('torn-api-key-input-main');
                apiKeySaveButtonMain = document.getElementById('torn-api-key-save-btn-main');
                apiErrorMain = apiSetupDiv.querySelector('.api-error-main');
                firstRunAutostartOptionDiv = document.getElementById('first-run-autostart-option');
                firstRunAutostartCheckbox = document.getElementById('first-run-autostart-checkbox');

                settingsPanel = document.getElementById('torn-status-settings-panel');
                settingsApiKeyInput = document.getElementById('torn-api-key-input-settings');
                settingsApiKeySaveButton = document.getElementById('torn-api-key-save-btn-settings');
                settingsApiKeyClearButton = document.getElementById('torn-api-key-clear-btn-settings');
                settingsApiError = settingsPanel.querySelector('.api-error-settings');
                settingsAutostartCheckbox = document.getElementById('settings-autostart-checkbox');
                settingsPanelCloseButton = document.getElementById('settings-panel-close-btn');

                if (!guiContainer) return;

                if (versionDiv) {
                     // Initial population of versionDiv, update notification will be added if needed
                    versionDiv.innerHTML = `Author: <a href="${AUTHOR_URL}" target="_blank" title="View Author's Profile">${AUTHOR_NAME}</a> | <a href="${FORUM_THREAD_URL}" target="_blank" title="Go to Forum Thread">v${SCRIPT_VERSION}</a><span id="update-notification" style="display:none;"> <a href="#" target="_blank">New version available!</a></span>`;
                    updateNotificationElement = document.getElementById('update-notification'); // Re-cache after innerHTML rewrite
                }


                if (isMinimized) {
                    guiContainer.classList.add('minimized');
                    if(minimizeButton) { minimizeButton.textContent = '□'; minimizeButton.title = 'Maximize'; }
                } else {
                    guiContainer.classList.remove('minimized');
                    if(minimizeButton) { minimizeButton.textContent = '−'; minimizeButton.title = 'Minimize'; }
                }

                lifeDisplayValue = guiContainer.querySelector('.life-value-overlay');
                healthBarFillDisplay = guiContainer.querySelector('.health-bar-fill');
                energyDisplayValue = guiContainer.querySelector('.energy-value');
                nerveDisplayValue = guiContainer.querySelector('.nerve-value');
                happinessDisplayValue = guiContainer.querySelector('.happy-value');
                boosterDisplayValue = guiContainer.querySelector('.booster-value');
                medicalDisplayValue = guiContainer.querySelector('.medical-value');
                drugDisplayValue = guiContainer.querySelector('.drug-value');

                energyTimerDisplay = guiContainer.querySelector('.energy-timer');
                nerveTimerDisplay = guiContainer.querySelector('.nerve-timer');
                happinessTimerDisplay = guiContainer.querySelector('.happy-timer');
                boosterTimerDisplay = guiContainer.querySelector('.booster-timer');
                medicalTimerDisplay = guiContainer.querySelector('.medical-timer');
                drugTimerDisplay = guiContainer.querySelector('.drug-timer');
                newDayTimerDisplay = guiContainer.querySelector('.new-day-timer-value');

                notificationsDiv = document.getElementById('torn-status-notifications');
                statusDiv = document.getElementById('torn-status-content');
                refillsDiv = document.getElementById('torn-status-refills');

                messagesIconDisplay = notificationsDiv.querySelector('.messages-icon');
                messagesCountDisplay = notificationsDiv.querySelector('.messages-count');
                eventsIconDisplay = notificationsDiv.querySelector('.events-icon');
                eventsCountDisplay = notificationsDiv.querySelector('.events-count');

                energyRefillStatus = refillsDiv.querySelector('.energy-refill-status');
                nerveRefillStatus = refillsDiv.querySelector('.nerve-refill-status');
                tokenRefillStatus = refillsDiv.querySelector('.token-refill-status');

                for (const key in itemLinkUrls) {
                    const item = itemLinkUrls[key];
                    if (item.elementId) {
                        linkTargetElements[key] = document.getElementById(item.elementId);
                    } else if (item.elementIds) {
                        linkTargetElements[key] = item.elementIds.map(id => document.getElementById(id));
                    }
                    linkToggleElements[key] = {
                        input: document.getElementById(item.toggleId),
                        personalLabel: document.getElementById(item.personalLabelId),
                        factionLabel: document.getElementById(item.factionLabelId)
                    };
                }


                if(minimizeButton) minimizeButton.addEventListener('click', toggleMinimize);
                if(closeButton) closeButton.addEventListener('click', async () => { await appWindow.close(); });
                if(settingsButton) settingsButton.addEventListener('click', toggleSettingsPanel);
                if(settingsPanelCloseButton) settingsPanelCloseButton.addEventListener('click', toggleSettingsPanel);

                if(apiKeySaveButtonMain) apiKeySaveButtonMain.addEventListener('click', () => saveApiKey(apiKeyInputMain, apiErrorMain));
                if(apiKeyInputMain) apiKeyInputMain.addEventListener('keypress',(e)=>{ if(e.key === 'Enter') saveApiKey(apiKeyInputMain, apiErrorMain); });

                if(settingsApiKeySaveButton) settingsApiKeySaveButton.addEventListener('click', () => saveApiKey(settingsApiKeyInput, settingsApiError, true));
                if(settingsApiKeyInput) settingsApiKeyInput.addEventListener('keypress',(e)=>{ if(e.key === 'Enter') saveApiKey(settingsApiKeyInput, settingsApiError, true); });
                if(settingsApiKeyClearButton) settingsApiKeyClearButton.addEventListener('click', promptClearApiKey);

                if(firstRunAutostartCheckbox) firstRunAutostartCheckbox.addEventListener('change', handleAutostartChange);
                if(settingsAutostartCheckbox) settingsAutostartCheckbox.addEventListener('change', handleAutostartChange);

                const widgetHeader = document.getElementById('torn-status-header');
                if (widgetHeader) {
                    widgetHeader.addEventListener('click', (e) => {
                        if (isMinimized && guiContainer.classList.contains('minimized') && e.target === widgetHeader) {
                            toggleMinimize();
                        }
                    });
                }

                const hoverAreas = guiContainer.querySelectorAll('.timer-hover-area');
                hoverAreas.forEach(area => {
                    area.addEventListener('mouseover', handleTooltipMouseOver);
                    area.addEventListener('mouseout', handleTooltipMouseOut);
                    area.addEventListener('mousemove', handleTooltipMouseMove);
                });
            }

            function toggleSettingsPanel() {
                if (!settingsPanel) return;
                const isVisible = settingsPanel.style.display === 'flex';
                settingsPanel.style.display = isVisible ? 'none' : 'flex';
                if (!isVisible) { 
                    if(settingsApiKeyInput) settingsApiKeyInput.value = '';
                    if(settingsApiError) settingsApiError.textContent = '';
                }
                resizeWindowToContent();
            }

            async function handleAutostartChange(event) {
                const isEnabled = event.target.checked;
                localStorage.setItem(AUTOSTART_PREFERENCE_STORAGE, isEnabled.toString());

                if (isEnabled) {
                    await enablePluginAutostart();
                } else {
                    await disablePluginAutostart();
                }
                if(firstRunAutostartCheckbox) firstRunAutostartCheckbox.checked = isEnabled;
                if(settingsAutostartCheckbox) settingsAutostartCheckbox.checked = isEnabled;
            }

            async function initializeAutostart() {
                let autostartPreference = localStorage.getItem(AUTOSTART_PREFERENCE_STORAGE);
                let shouldEnablePlugin = false;

                if (autostartPreference === null) {
                    shouldEnablePlugin = true;
                    localStorage.setItem(AUTOSTART_PREFERENCE_STORAGE, 'true');
                    autostartPreference = 'true';
                } else {
                    shouldEnablePlugin = autostartPreference === 'true';
                }

                if (shouldEnablePlugin) {
                    await enablePluginAutostart();
                }
                const isChecked = autostartPreference === 'true';
                if(firstRunAutostartCheckbox) firstRunAutostartCheckbox.checked = isChecked;
                if(settingsAutostartCheckbox) settingsAutostartCheckbox.checked = isChecked;
            }

            function updateLinkPreferenceUI(itemKey, isFaction) {
                const toggleInfo = linkToggleElements[itemKey];
                if (toggleInfo && toggleInfo.personalLabel && toggleInfo.factionLabel) {
                    toggleInfo.personalLabel.classList.toggle('active-preference', !isFaction);
                    toggleInfo.factionLabel.classList.toggle('active-preference', isFaction);
                }
            }

            function applyLinkPreference(itemKey, isFaction) {
                const urlDetails = itemLinkUrls[itemKey];
                const targetLinkElementOrArray = linkTargetElements[itemKey];

                if (!urlDetails || !targetLinkElementOrArray) {
                    console.warn(`No URL details or target element for ${itemKey}`);
                    return;
                }

                const newUrl = isFaction ? urlDetails.faction : urlDetails.personal;

                if (Array.isArray(targetLinkElementOrArray)) {
                    targetLinkElementOrArray.forEach(el => {
                        if (el) el.href = newUrl;
                    });
                } else {
                    if (targetLinkElementOrArray) targetLinkElementOrArray.href = newUrl;
                }
                updateLinkPreferenceUI(itemKey, isFaction);
            }

            function initializeLinkTypeSettings() {
                Object.keys(itemLinkUrls).forEach(itemKey => {
                    const toggleInfo = linkToggleElements[itemKey];
                    if (!toggleInfo || !toggleInfo.input) {
                        console.warn(`Toggle input not found for ${itemKey}`);
                        return;
                    }

                    const savedSetting = localStorage.getItem(LINK_TYPE_SETTINGS_PREFIX + itemKey);
                    const isFaction = savedSetting === 'faction'; 

                    toggleInfo.input.checked = isFaction;
                    applyLinkPreference(itemKey, isFaction);

                    toggleInfo.input.addEventListener('change', (event) => {
                        const newIsFaction = event.target.checked;
                        localStorage.setItem(LINK_TYPE_SETTINGS_PREFIX + itemKey, newIsFaction ? 'faction' : 'personal');
                        applyLinkPreference(itemKey, newIsFaction);
                    });
                });
            }


            function handleTooltipMouseOver(event) {
                const targetElement = event.currentTarget;
                const timerSpan = targetElement.querySelector('.timer');
                if (customTooltipElement && timerSpan && timerSpan.dataset.tooltipContent) {
                    customTooltipElement.innerHTML = timerSpan.dataset.tooltipContent;
                    customTooltipElement.style.display = 'block';
                    positionTooltip(event.pageX, event.pageY);
                }
            }
            function handleTooltipMouseOut() {
                if (customTooltipElement) {
                    customTooltipElement.style.display = 'none';
                }
            }
            function handleTooltipMouseMove(event) {
                if (customTooltipElement && customTooltipElement.style.display === 'block') {
                    positionTooltip(event.pageX, event.pageY);
                }
            }

            function positionTooltip(x, y) {
                if (!customTooltipElement) return;
                const offsetX = 10, offsetY = 15;
                let newX = x + offsetX;
                let newY = y + offsetY;

                const tooltipRect = customTooltipElement.getBoundingClientRect();
                const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;

                if (newX + tooltipRect.width > viewportWidth) {
                    newX = x - tooltipRect.width - offsetX;
                }
                if (newY + tooltipRect.height > viewportHeight) {
                    newY = y - tooltipRect.height - offsetY;
                }
                if (newX < 0) newX = 0;
                if (newY < 0) newY = 0;

                customTooltipElement.style.left = `${newX}px`;
                customTooltipElement.style.top = `${newY}px`;
            }

            async function fetchData(){
                if(!apiKey){updateDisplay({error:"API Key needed",target:'api_main'});switchView(false);return}
                const url=`https://api.torn.com/user/?selections=bars,cooldowns,refills,personalstats,notifications&key=${apiKey}&comment=TornStatusWidget_v${SCRIPT_VERSION}`;
                const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);
                try{
                    const response=await fetch(url,{method:'GET',signal:controller.signal});clearTimeout(timeoutId);
                    if(!response.ok){
                        let errorData;try{errorData=await response.json()}catch(parseErr){throw new Error(`HTTP error ${response.status}`)}
                        if(errorData&&errorData.error){
                            const errMessage=`API Error ${errorData.error.code}`;
                            const errorTarget = (settingsPanel && settingsPanel.style.display === 'flex') ? 'api_settings' : 'api_main';
                            updateDisplay({error:errMessage,target: errorTarget });
                            if(errorData.error.code===2){ 
                                apiKey=null;localStorage.removeItem(API_KEY_STORAGE);
                                if(intervals.update)clearInterval(intervals.update);intervals.update=null;
                                switchView(false);
                                if(settingsPanel && settingsPanel.style.display === 'flex') toggleSettingsPanel(); 
                            }
                        }else{throw new Error(`HTTP error ${response.status}`)}
                        clearAllTimers();return
                    }
                    const data=await response.json();
                    if(data.error){
                        const errMessage=`API Error ${data.error.code}`;
                        const errorTarget = (settingsPanel && settingsPanel.style.display === 'flex') ? 'api_settings' : 'api_main';
                        updateDisplay({error:errMessage, target: errorTarget});
                        if(data.error.code===2){ 
                            apiKey=null;localStorage.removeItem(API_KEY_STORAGE);
                            if(intervals.update)clearInterval(intervals.update);intervals.update=null;
                            switchView(false);
                             if(settingsPanel && settingsPanel.style.display === 'flex') toggleSettingsPanel(); 
                        }clearAllTimers()
                    }else{
                        updateDisplay(data);startTimers(data);clearErrorMessages();
                        if(!isMinimized && !(settingsPanel && settingsPanel.style.display === 'flex')) switchView(true);
                    }
                }catch(error){clearTimeout(timeoutId);if(error.name==='AbortError'){updateDisplay({error:"Timeout",target:'status'})}else{updateDisplay({error:error.message||"Network Error",target:'status'})}clearAllTimers()}
            }

            function updateDisplay(data){
                const currentApiErrorDiv = (settingsPanel && settingsPanel.style.display === 'flex') ? settingsApiError : apiErrorMain;
                const statusErrDiv=guiContainer.querySelector('.status-error');

                if(currentApiErrorDiv) currentApiErrorDiv.textContent = '';
                if(statusErrDiv) statusErrDiv.textContent = '';

                if(data.error){
                    let errTargetDiv;
                    if (data.target === 'api_main' && apiErrorMain) errTargetDiv = apiErrorMain;
                    else if (data.target === 'api_settings' && settingsApiError) errTargetDiv = settingsApiError;
                    else if (data.target === 'status' && statusErrDiv) errTargetDiv = statusErrDiv;
                    else if (currentApiErrorDiv) errTargetDiv = currentApiErrorDiv; 

                    if(errTargetDiv) errTargetDiv.textContent=`Error: ${data.error}`;

                    if(lifeDisplayValue) lifeDisplayValue.textContent = '--/--';
                    if(healthBarFillDisplay) healthBarFillDisplay.style.width = '0%';
                    if(energyDisplayValue)energyDisplayValue.textContent='--/--';
                    if(nerveDisplayValue)nerveDisplayValue.textContent='--/--';
                    if(happinessDisplayValue)happinessDisplayValue.textContent='--/--';
                    if(boosterDisplayValue)boosterDisplayValue.textContent='--';
                    if(medicalDisplayValue)medicalDisplayValue.textContent='--';
                    if(drugDisplayValue)drugDisplayValue.textContent='--';
                    if(messagesIconDisplay) messagesIconDisplay.innerHTML = mailIconSVG;
                    if(messagesCountDisplay) {messagesCountDisplay.textContent = '--'; messagesIconDisplay.className = 'notification-icon messages-icon green'; messagesCountDisplay.className = 'notification-count messages-count green';}
                    if(eventsIconDisplay) eventsIconDisplay.innerHTML = eventIconSVG;
                    if(eventsCountDisplay) {eventsCountDisplay.textContent = '--'; eventsIconDisplay.className = 'notification-icon events-icon green'; eventsCountDisplay.className = 'notification-count events-count green';}
                    if(energyRefillStatus) energyRefillStatus.textContent = '--';
                    if(nerveRefillStatus) nerveRefillStatus.textContent = '--';
                    if(tokenRefillStatus) tokenRefillStatus.textContent = '--';
                    resizeWindowToContent();
                    return;
                }

                if (data.personalstats && typeof data.personalstats.boosters_max_cooldown_hours === 'number') {
                    userMaxBoosterCooldownSeconds = data.personalstats.boosters_max_cooldown_hours * 3600;
                }


                if (data.notifications) {
                    const msgCount = data.notifications.messages || 0;
                    const evtCount = data.notifications.events || 0;
                    if (messagesIconDisplay) messagesIconDisplay.innerHTML = mailIconSVG;
                    if (messagesCountDisplay) {
                        messagesCountDisplay.textContent = msgCount;
                        messagesIconDisplay.className = msgCount > 0 ? 'notification-icon messages-icon red' : 'notification-icon messages-icon green';
                        messagesCountDisplay.className = msgCount > 0 ? 'notification-count messages-count red' : 'notification-count messages-count green';
                    }
                    if (eventsIconDisplay) eventsIconDisplay.innerHTML = eventIconSVG;
                    if (eventsCountDisplay) {
                        eventsCountDisplay.textContent = evtCount;
                        eventsIconDisplay.className = evtCount > 0 ? 'notification-icon events-icon red' : 'notification-icon events-icon green';
                        eventsCountDisplay.className = evtCount > 0 ? 'notification-count events-count red' : 'notification-count events-count green';
                    }
                } else {
                    if(messagesIconDisplay) messagesIconDisplay.innerHTML = mailIconSVG;
                    if(messagesCountDisplay) { messagesCountDisplay.textContent = 'N/A'; messagesIconDisplay.className = 'notification-icon messages-icon green'; messagesCountDisplay.className = 'notification-count messages-count green';}
                    if(eventsIconDisplay) eventsIconDisplay.innerHTML = eventIconSVG;
                    if(eventsCountDisplay) { eventsCountDisplay.textContent = 'N/A'; eventsIconDisplay.className = 'notification-icon events-icon green'; eventsCountDisplay.className = 'notification-count events-count green';}
                }

                if(lifeDisplayValue && data.life && typeof data.life.current !=='undefined' && typeof data.life.maximum !=='undefined' && data.life.maximum > 0){
                    lifeDisplayValue.textContent=`${data.life.current}/${data.life.maximum}`;
                    if (healthBarFillDisplay) {
                        const percentage = (data.life.current / data.life.maximum) * 100;
                        healthBarFillDisplay.style.width = `${Math.max(0, Math.min(100, percentage))}%`;
                        if (percentage <= 25) {
                            healthBarFillDisplay.style.backgroundColor = '#dc3545'; 
                        } else if (percentage <= 50) {
                            healthBarFillDisplay.style.backgroundColor = '#ffc107'; 
                        } else {
                            healthBarFillDisplay.style.backgroundColor = '#28a745'; 
                        }
                    }
                } else if (lifeDisplayValue) {
                    lifeDisplayValue.textContent='N/A';
                    if (healthBarFillDisplay) {
                         healthBarFillDisplay.style.width = '0%';
                         healthBarFillDisplay.style.backgroundColor = '#444'; 
                    }
                }

                if(energyDisplayValue&&data.energy&&typeof data.energy.current!=='undefined')energyDisplayValue.textContent=`${data.energy.current}/${data.energy.maximum}`;else if(energyDisplayValue)energyDisplayValue.textContent='N/A';
                if(nerveDisplayValue&&data.nerve&&typeof data.nerve.current!=='undefined')nerveDisplayValue.textContent=`${data.nerve.current}/${data.nerve.maximum}`;else if(nerveDisplayValue)nerveDisplayValue.textContent='N/A';
                if(happinessDisplayValue&&data.happy&&typeof data.happy.current!=='undefined')happinessDisplayValue.textContent=`${data.happy.current}/${data.happy.maximum}`;else if(happinessDisplayValue)happinessDisplayValue.textContent='N/A';

                if (data.cooldowns) {
                    if (boosterDisplayValue) {
                        boosterDisplayValue.textContent = data.cooldowns.booster > 0 ? 'Active' : 'Ready';
                        if (data.cooldowns.booster === 0) {
                            boosterDisplayValue.classList.add('flashing');
                            if (boosterTimerDisplay) boosterTimerDisplay.classList.add('flashing');
                        } else {
                            boosterDisplayValue.classList.remove('flashing');
                            if (boosterTimerDisplay) boosterTimerDisplay.classList.remove('flashing');
                        }
                    }
                    if (medicalDisplayValue) {
                        medicalDisplayValue.textContent = data.cooldowns.medical > 0 ? 'Active' : 'Ready';
                         if (data.cooldowns.medical === 0) {
                        } else {
                        }
                    }
                    if (drugDisplayValue) {
                        drugDisplayValue.textContent = data.cooldowns.drug > 0 ? 'Active' : 'Ready';
                        if (data.cooldowns.drug === 0) {
                            drugDisplayValue.classList.add('flashing');
                            if (drugTimerDisplay) drugTimerDisplay.classList.add('flashing');
                        } else {
                            drugDisplayValue.classList.remove('flashing');
                            if (drugTimerDisplay) drugTimerDisplay.classList.remove('flashing');
                        }
                    }
                } else {
                    if(boosterDisplayValue) { boosterDisplayValue.textContent = 'N/A'; boosterDisplayValue.classList.remove('flashing'); if(boosterTimerDisplay) boosterTimerDisplay.classList.remove('flashing');}
                    if(medicalDisplayValue) { medicalDisplayValue.textContent = 'N/A'; medicalDisplayValue.classList.remove('flashing'); if(medicalTimerDisplay) medicalTimerDisplay.classList.remove('flashing');}
                    if(drugDisplayValue) { drugDisplayValue.textContent = 'N/A'; drugDisplayValue.classList.remove('flashing'); if(drugTimerDisplay) drugTimerDisplay.classList.remove('flashing');}
                }

                if (data.refills) {
                    if (energyRefillStatus) {
                        energyRefillStatus.textContent = data.refills.energy_refill_used ? 'Used' : 'Ready';
                        energyRefillStatus.className = data.refills.energy_refill_used ? 'refill-status used' : 'refill-status ready';
                    }
                    if (nerveRefillStatus) {
                        nerveRefillStatus.textContent = data.refills.nerve_refill_used ? 'Used' : 'Ready';
                        nerveRefillStatus.className = data.refills.nerve_refill_used ? 'refill-status used' : 'refill-status ready';
                    }
                    if (tokenRefillStatus) {
                        tokenRefillStatus.textContent = data.refills.token_refill_used ? 'Used' : 'Ready';
                        tokenRefillStatus.className = data.refills.token_refill_used ? 'refill-status used' : 'refill-status ready';
                    }
                } else {
                    if(energyRefillStatus) energyRefillStatus.textContent = 'N/A';
                    if(nerveRefillStatus) nerveRefillStatus.textContent = 'N/A';
                    if(tokenRefillStatus) tokenRefillStatus.textContent = 'N/A';
                }
                resizeWindowToContent();
            }

            function startTimers(data){
                clearAllTimers();
                if(data.energy&&typeof data.energy.fulltime!=='undefined'&&energyTimerDisplay)updateTimer('energy',data.energy.fulltime,energyTimerDisplay, 0);else if(energyTimerDisplay){energyTimerDisplay.textContent="N/A";energyTimerDisplay.classList.remove('full')}
                if(data.nerve&&typeof data.nerve.fulltime!=='undefined'&&nerveTimerDisplay)updateTimer('nerve',data.nerve.fulltime,nerveTimerDisplay, 0);else if(nerveTimerDisplay){nerveTimerDisplay.textContent="N/A";nerveTimerDisplay.classList.remove('full')}
                if(data.happy&&typeof data.happy.fulltime!=='undefined'&&happinessTimerDisplay)updateTimer('happiness',data.happy.fulltime,happinessTimerDisplay, 0);else if(happinessTimerDisplay){happinessTimerDisplay.textContent="N/A";happinessTimerDisplay.classList.remove('full')}

                if (data.cooldowns) {
                    if (typeof data.cooldowns.booster !== 'undefined' && boosterTimerDisplay) {
                        if (data.cooldowns.booster > 0) {
                            updateTimer('booster', data.cooldowns.booster, boosterTimerDisplay, userMaxBoosterCooldownSeconds);
                        } else {
                            boosterTimerDisplay.textContent = formatSecondsToHMS(userMaxBoosterCooldownSeconds);
                            boosterTimerDisplay.classList.add('full');
                            boosterTimerDisplay.classList.add('flashing');
                            if(boosterDisplayValue) boosterDisplayValue.classList.add('flashing');
                            boosterTimerDisplay.dataset.tooltipContent = `Ready\nMax Duration: ${formatSecondsToHMS(userMaxBoosterCooldownSeconds)}`;
                        }
                    } else if (boosterTimerDisplay) {
                        boosterTimerDisplay.textContent = "N/A";
                        boosterTimerDisplay.classList.remove('full','flashing');
                        if(boosterDisplayValue) boosterDisplayValue.classList.remove('flashing');
                        boosterTimerDisplay.dataset.tooltipContent = "Booster: N/A";
                    }

                    if (typeof data.cooldowns.medical !== 'undefined' && medicalTimerDisplay) {
                        if (data.cooldowns.medical > 0) {
                            updateTimer('medical', data.cooldowns.medical, medicalTimerDisplay, userMaxMedicalCooldownSeconds);
                        } else {
                            medicalTimerDisplay.textContent = formatSecondsToHMS(userMaxMedicalCooldownSeconds);
                            medicalTimerDisplay.classList.add('full');
                            medicalTimerDisplay.dataset.tooltipContent = `Ready\nMax Duration: ${formatSecondsToHMS(userMaxMedicalCooldownSeconds)}`;
                        }
                    } else if (medicalTimerDisplay) {
                        medicalTimerDisplay.textContent = "N/A";
                        medicalTimerDisplay.classList.remove('full','flashing');
                         if(medicalDisplayValue) medicalDisplayValue.classList.remove('flashing');
                        medicalTimerDisplay.dataset.tooltipContent = "Medical: N/A";
                    }

                    if (typeof data.cooldowns.drug !== 'undefined' && drugTimerDisplay) {
                        if (data.cooldowns.drug > 0) {
                             updateTimer('drug', data.cooldowns.drug, drugTimerDisplay, 0); 
                        } else {
                            drugTimerDisplay.textContent = 'Ready';
                            drugTimerDisplay.classList.add('full');
                            drugTimerDisplay.classList.add('flashing');
                            if(drugDisplayValue) drugDisplayValue.classList.add('flashing');
                            drugTimerDisplay.dataset.tooltipContent = `Ready`;
                        }
                    } else if (drugTimerDisplay) {
                        drugTimerDisplay.textContent = "N/A";
                        drugTimerDisplay.classList.remove('full','flashing');
                        if(drugDisplayValue) drugDisplayValue.classList.remove('flashing');
                        drugTimerDisplay.dataset.tooltipContent = "Drug: N/A";
                    }
                }
                startNewDayTimer();
            }

            function startNewDayTimer() {
                if (intervals.newDay) clearInterval(intervals.newDay);
                if (!newDayTimerDisplay) return;

                function update() {
                    const now = new Date();
                    const tomorrowUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0, 0));
                    const diffSeconds = Math.floor((tomorrowUTC.getTime() - now.getTime()) / 1000);

                    const isWarningPeriod = diffSeconds < 3600 && diffSeconds >= 0; 

                    if (isWarningPeriod) {
                        newDayTimerDisplay.classList.add('new-day-warning');
                    } else {
                        newDayTimerDisplay.classList.remove('new-day-warning');
                    }

                    newDayTimerDisplay.textContent = formatSecondsToHMS(diffSeconds >= 0 ? diffSeconds : 0);

                    let newDayShouldFlash = false;
                    if (energyRefillStatus) {
                        if (isWarningPeriod && energyRefillStatus.textContent === 'Ready') {
                            energyRefillStatus.classList.add('flashing');
                            newDayShouldFlash = true;
                        } else {
                            energyRefillStatus.classList.remove('flashing');
                        }
                    }
                    if (nerveRefillStatus) {
                        if (isWarningPeriod && nerveRefillStatus.textContent === 'Ready') {
                            nerveRefillStatus.classList.add('flashing');
                            newDayShouldFlash = true;
                        } else {
                            nerveRefillStatus.classList.remove('flashing');
                        }
                    }

                    if (newDayShouldFlash && isWarningPeriod) {
                        newDayTimerDisplay.classList.add('flashing');
                    } else {
                        newDayTimerDisplay.classList.remove('flashing');
                    }
                }
                update();
                intervals.newDay = setInterval(update, 1000);
            }


            function updateTimer(barName, initialSecondsRemaining, displayElement, maxCooldownSeconds) {
                if (!displayElement) return;
                if (intervals[barName]) clearTimeout(intervals[barName]); 

                let secondsRemaining = Number(initialSecondsRemaining);
                if (isNaN(secondsRemaining)) {
                    displayElement.textContent = "Error";
                    displayElement.classList.remove('full', 'flashing');
                    if (barName === 'booster' && boosterDisplayValue) boosterDisplayValue.classList.remove('flashing');
                    if (barName === 'drug' && drugDisplayValue) drugDisplayValue.classList.remove('flashing');
                    displayElement.dataset.tooltipContent = "Error";
                    intervals[barName] = null;
                    return;
                }

                let valueDisplayElement = null;
                if (barName === 'booster') valueDisplayElement = boosterDisplayValue;
                else if (barName === 'medical') valueDisplayElement = medicalDisplayValue;
                else if (barName === 'drug') valueDisplayElement = drugDisplayValue;


                function tick() {
                    let currentTooltipText = '';
                    const now = Date.now();

                    if (secondsRemaining <= 0) {
                        displayElement.classList.add('full'); 
                        intervals[barName] = null; 

                        if ((barName === 'booster' || barName === 'medical' || barName === 'drug')) {
                             if (valueDisplayElement) valueDisplayElement.textContent = 'Ready';
                             if (barName === 'booster' || barName === 'drug') { 
                                if (valueDisplayElement) valueDisplayElement.classList.add('flashing');
                                displayElement.classList.add('flashing');
                             }
                        }

                        if ((barName === 'booster' || barName === 'medical') && maxCooldownSeconds > 0) {
                            displayElement.textContent = formatSecondsToHMS(maxCooldownSeconds);
                            currentTooltipText = `Ready\nMax Duration: ${formatSecondsToHMS(maxCooldownSeconds)}`;
                        } else if (barName === 'drug') {
                            displayElement.textContent = "Ready"; 
                            currentTooltipText = `Ready`;
                        } else { 
                            displayElement.textContent = "Full";
                            currentTooltipText = `Full`;
                        }
                        displayElement.dataset.tooltipContent = currentTooltipText;

                    } else {
                        displayElement.classList.remove('full', 'flashing');
                        if (valueDisplayElement) valueDisplayElement.classList.remove('flashing');
                        if (valueDisplayElement && (barName === 'booster' || barName === 'medical' || barName === 'drug')){
                             valueDisplayElement.textContent = 'Active';
                        }

                        const endsTimestamp = new Date(now + secondsRemaining * 1000).toLocaleString([], {dateStyle: 'short', timeStyle: 'medium'});

                        if ((barName === 'booster' || barName === 'medical') && maxCooldownSeconds > 0) {
                            displayElement.textContent = formatSecondsToHMS(secondsRemaining); 
                            currentTooltipText = `Ends: ${endsTimestamp}\nUsed: ${formatSecondsToHMS(secondsRemaining)}`;
                        } else if (barName === 'drug') {
                            displayElement.textContent = formatSecondsToHMS(secondsRemaining);
                            currentTooltipText = `Ends: ${endsTimestamp}\n(Drug active)`;
                        } else { 
                            displayElement.textContent = formatSecondsToHMS(secondsRemaining);
                            currentTooltipText = `Ends: ${endsTimestamp}`;
                        }
                        displayElement.dataset.tooltipContent = currentTooltipText;
                        secondsRemaining--;
                        intervals[barName] = setTimeout(tick, 1000); 
                    }
                }
                tick(); 
            }


            function clearAllTimers(){
                Object.keys(intervals).forEach(key => {
                    if (intervals[key]) {
                        clearInterval(intervals[key]); 
                        clearTimeout(intervals[key]);  
                        intervals[key] = null;
                    }
                });
                const elementsToClearFlash = [
                    energyRefillStatus, nerveRefillStatus, newDayTimerDisplay,
                    boosterDisplayValue, boosterTimerDisplay,
                    drugDisplayValue, drugTimerDisplay,
                    medicalDisplayValue, medicalTimerDisplay
                ];
                elementsToClearFlash.forEach(el => {
                    if (el) el.classList.remove('flashing', 'new-day-warning');
                });

                const timersToReset = [
                    energyTimerDisplay, nerveTimerDisplay, happinessTimerDisplay,
                    boosterTimerDisplay, medicalTimerDisplay, drugTimerDisplay,
                    newDayTimerDisplay
                ];
                timersToReset.forEach(timer => {
                    if(timer){ timer.textContent='--:--:--'; if(timer.classList) timer.classList.remove('full'); if(timer.dataset) timer.dataset.tooltipContent = "";}
                });
            }
            function clearErrorMessages(){
                if(apiErrorMain) apiErrorMain.textContent = '';
                if(settingsApiError) settingsApiError.textContent = '';
                const statusErrDiv = guiContainer.querySelector('.status-error');
                if(statusErrDiv) statusErrDiv.textContent = '';
            }

            function toggleMinimize(){
                isMinimized=!isMinimized;
                if(guiContainer) guiContainer.classList.toggle('minimized',isMinimized);
                if(minimizeButton){minimizeButton.textContent=isMinimized?'□':'−';minimizeButton.title=isMinimized?'Maximize':'Minimize'}
                localStorage.setItem(GUI_MINIMIZED_STORAGE,isMinimized.toString());

                if (!isMinimized && settingsPanel && settingsPanel.style.display === 'flex') {
                    settingsPanel.style.display = 'none'; 
                    resizeWindowToContent();
                    settingsPanel.style.display = 'flex'; 
                    resizeWindowToContent(); 
                } else {
                     resizeWindowToContent();
                }

                if(!isMinimized && apiKey) {
                    switchView(true);
                } else if (!isMinimized && !apiKey) {
                    switchView(false);
                }
            }

            function saveApiKey(inputElement, errorElement, fromSettings = false){
                if(!inputElement || !errorElement) return;
                const newKey = inputElement.value.trim();
                if(newKey && /^[a-zA-Z0-9]{16}$/.test(newKey)){
                    apiKey = newKey;
                    localStorage.setItem(API_KEY_STORAGE, apiKey);
                    inputElement.value = '';
                    clearErrorMessages();
                    switchView(true); 
                    if(intervals.update) clearInterval(intervals.update); 
                    fetchData(); 
                    intervals.update = setInterval(fetchData, UPDATE_INTERVAL_MS); 
                    if(fromSettings) {
                        toggleSettingsPanel(); 
                    }
                } else {
                    errorElement.textContent = "Invalid Key format (16 letters/numbers)";
                }
            }

            function promptClearApiKey() {
                apiKey = null;
                localStorage.removeItem(API_KEY_STORAGE);
                if (intervals.update) {
                    clearInterval(intervals.update);
                    intervals.update = null;
                }
                clearAllTimers();
                updateDisplay({ error: "API Key cleared.", target: 'api_settings' }); 
                if(settingsApiKeyInput) settingsApiKeyInput.value = ''; 
            }


            function switchView(showStatus) {
                if (!apiSetupDiv || !notificationsDiv || !statusDiv || !refillsDiv || !guiContainer || !firstRunAutostartOptionDiv) return;

                if (showStatus && apiKey) { 
                    notificationsDiv.style.setProperty('display', 'flex', 'important');
                    statusDiv.style.setProperty('display', 'block', 'important');
                    refillsDiv.style.setProperty('display', 'block', 'important');
                    apiSetupDiv.style.setProperty('display', 'none', 'important');
                    firstRunAutostartOptionDiv.style.display = 'none'; 
                } else { 
                    apiSetupDiv.style.setProperty('display', 'block', 'important');
                    notificationsDiv.style.setProperty('display', 'none', 'important');
                    statusDiv.style.setProperty('display', 'none', 'important');
                    refillsDiv.style.setProperty('display', 'none', 'important');
                    firstRunAutostartOptionDiv.style.display = apiKey ? 'none' : 'block';
                }
                if (!(settingsPanel && settingsPanel.style.display === 'flex')) {
                    resizeWindowToContent();
                }
            }

            // --- Version Check Functions ---
            function isNewerVersion(latestVersionTag, currentVersion) {
                const latest = latestVersionTag.replace(/^v/, '').split('.').map(Number);
                const current = currentVersion.replace(/^v/, '').split('.').map(Number);

                for (let i = 0; i < Math.max(latest.length, current.length); i++) {
                    const latestPart = latest[i] || 0;
                    const currentPart = current[i] || 0;
                    if (latestPart > currentPart) return true;
                    if (latestPart < currentPart) return false;
                }
                return false; // Versions are identical
            }

            async function checkForUpdates() {
                try {
                    const response = await fetch(GITHUB_RELEASES_API_URL);
                    if (!response.ok) {
                        console.error(`GitHub API error: ${response.status}`);
                        return;
                    }
                    const releaseData = await response.json();
                    const latestVersionTag = releaseData.tag_name;

                    if (latestVersionTag && isNewerVersion(latestVersionTag, SCRIPT_VERSION)) {
                        if (updateNotificationElement) {
                            const updateLink = updateNotificationElement.querySelector('a');
                            if (updateLink) {
                                updateLink.href = GITHUB_RELEASES_PAGE_URL;
                                updateLink.textContent = `Update to ${latestVersionTag} available!`;
                            }
                            updateNotificationElement.style.display = 'inline'; // Show the notification
                            resizeWindowToContent(); // Adjust window size if notification makes it taller
                        }
                    }
                } catch (error) {
                    console.error("Failed to check for updates:", error);
                }
            }
            // --- End Version Check Functions ---

            async function init() {
                apiKey = localStorage.getItem(API_KEY_STORAGE) || null;
                isMinimized = localStorage.getItem(GUI_MINIMIZED_STORAGE) === 'true';

                cacheGUIElements(); 
                await initializeAutostart();
                initializeLinkTypeSettings(); 
                startNewDayTimer(); 
                checkForUpdates(); // Check for updates on init

                if(!guiContainer) return;

                const requiresApiSetup = !apiKey;
                if(requiresApiSetup){
                    if(!isMinimized){ switchView(false); } 
                    else{ 
                        if(apiSetupDiv) apiSetupDiv.style.setProperty('display','block','important');
                        if(notificationsDiv) notificationsDiv.style.setProperty('display','none','important');
                        if(statusDiv) statusDiv.style.setProperty('display','none','important');
                        if(refillsDiv) refillsDiv.style.setProperty('display','none','important');
                        if(firstRunAutostartOptionDiv) firstRunAutostartOptionDiv.style.display = 'block';
                    }
                }
                else{ 
                    if(intervals.update) clearInterval(intervals.update);
                    fetchData(); 
                    intervals.update=setInterval(fetchData,UPDATE_INTERVAL_MS); 
                    if(!isMinimized){ switchView(true); } 
                    else { 
                        if(notificationsDiv) notificationsDiv.style.setProperty('display','flex','important');
                        if(statusDiv) statusDiv.style.setProperty('display','block','important');
                        if(refillsDiv) refillsDiv.style.setProperty('display','block','important');
                        if(apiSetupDiv) apiSetupDiv.style.setProperty('display','none','important');
                        if(firstRunAutostartOptionDiv) firstRunAutostartOptionDiv.style.display = 'none';
                    }
                }
                if (!isMinimized || (apiKey && !(settingsPanel && settingsPanel.style.display === 'flex'))) {
                     resizeWindowToContent();
                }
            }

            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                init();
            } else {
                document.addEventListener('DOMContentLoaded', init);
            }
        })();
    </script>
</body>
</html>
